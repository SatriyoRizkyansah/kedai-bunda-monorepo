version: "3.8"

services:
  # ================================
  # API Service (Laravel PHP-FPM)
  # ================================
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: kedai-api
    restart: unless-stopped
    volumes:
      - api-storage:/var/www/html/storage
      - api-database:/var/www/html/database
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_URL=${APP_URL:-http://localhost}
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/database/database.sqlite
      - JWT_SECRET=${JWT_SECRET}
      - LOG_CHANNEL=stack
      - CACHE_STORE=file
      - SESSION_DRIVER=file
      - QUEUE_CONNECTION=sync
    networks:
      - kedai-network
    healthcheck:
      test: ["CMD", "php-fpm", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ================================
  # API Nginx (Reverse Proxy for PHP)
  # ================================
  api-nginx:
    image: nginx:alpine
    container_name: kedai-api-nginx
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:80"
    volumes:
      - ./docker/nginx/api.conf:/etc/nginx/conf.d/default.conf:ro
      - api-storage:/var/www/html/storage:ro
    depends_on:
      - api
    networks:
      - kedai-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ================================
  # Web Service (React/Vite)
  # ================================
  web:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:8000/api}
    container_name: kedai-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-80}:80"
    depends_on:
      - api-nginx
    networks:
      - kedai-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  kedai-network:
    driver: bridge

volumes:
  api-storage:
    driver: local
  api-database:
    driver: local
